<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Galaxy Clustering Visualization</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <header>
    <h1>3D Galaxy Clustering and Redshift-Space Distortions</h1>
    <p>Using Real Data from the Sloan Digital Sky Survey (SDSS)</p>
  </header>

  <section class="intro">
    <h2>Project Goals</h2>
    <p>This project explores the structure of the universe by analyzing how galaxies are spread out in space. Using data from the Sloan Digital Sky Survey (SDSS), I:</p>
    <ul>
      <li>Convert galaxy coordinates (RA, Dec, redshift) into 3D space</li>
      <li>Visualize how galaxies are distributed in the universe</li>
      <li>Measure how galaxies cluster together at different distances</li>
      <li>Study how galaxy motion affects what we observe (redshift distortions)</li>
    </ul>
  </section>

  <section class="phase">
    <h2>Phase 1: Data Acquisition & Preparation</h2>
    <p>I used SDSS DR18 data to get galaxy coordinates. Here's the SQL query I used:</p>
    <pre><code>SELECT TOP 10000
      specObjID, ra, dec, z
    FROM SpecObj
    WHERE class = 'GALAXY'
      AND z > 0.01 AND z < 0.3
      AND zWarning = 0</code></pre>
    <p>I filtered galaxies with reliable redshifts and converted their positions to 3D using <code>astropy</code>. I then plotted the redshift distribution and made 3D scatter plots of galaxy positions.</p>
  </section>

  <section class="phase">
    <h2>Phase 2: Clustering Analysis</h2>
    <p>Galaxies aren’t spread randomly. Gravity causes them to group together — this is called <strong>clustering</strong>. The tool I used to measure it is the <strong>2-point correlation function</strong> (2PCF), which answers:</p>
    <blockquote>
      “How likely is it to find two galaxies a certain distance apart, compared to random?”
    </blockquote>

    <ul>
      <li><strong>DD:</strong> Pairs of real galaxies</li>
      <li><strong>RR:</strong> Pairs of random (uniform) points</li>
      <li><strong>DR:</strong> Cross-pairs between real and random</li>
    </ul>
    <p>Small distances (~5-10 Mpc): strong clustering (positive values)<br>
    Large distances (~50+ Mpc): random (correlation near 0)</p>
  </section>

  <section class="phase">
    <h2>Phase 3: Redshift-Space Distortions (RSD)</h2>
    <p>Galaxies don’t just move because of cosmic expansion — they also move due to gravity. This messes with the redshift we observe.</p>

    <h3>Real vs Redshift Space</h3>
    <ul>
      <li><strong>Real space:</strong> Galaxy positions using only cosmic expansion</li>
      <li><strong>Redshift space:</strong> What we see, including local motion</li>
    </ul>

    <h3>Two types of distortions:</h3>
    <ol>
      <li><strong>Small scale:</strong> Random motion in clusters → looks stretched along our view (weaker signal)</li>
      <li><strong>Large scale:</strong> Infall toward dense areas → looks squished (stronger signal)</li>
    </ol>

    <p>I simulated this by adding random velocities to each galaxy’s redshift and recalculated their positions and clustering.</p>
  </section>

  <section class="controls">
    <label for="galaxyCount">Number of Galaxies:</label>
    <input type="number" id="galaxyCount" min="100" max="5000" value="1000" step="100" />

    <label for="velocityDispersion">Velocity Dispersion (km/s):</label>
    <input type="number" id="velocityDispersion" min="0" max="1000" value="300" step="50" />

    <button id="updateBtn">Recalculate Correlation</button>
    <button id="fetchGalaxiesBtn">Fetch Galaxies</button>
  </section>

  <section>
    <div id="statusMessage" style="display:none; margin-top:10px; color:#555; font-weight: bold;">
    </div>
  </section>

  <section class="plots">
    <div class="plot-row">
      <div class="plot-container">
        <h2>3D Galaxy Distribution (Cartesian Coordinates)</h2>
        <div id="galaxyPlot" class="plot"></div>
      </div>
      <div class="plot-container">
        <h2>Two-Point Correlation Function</h2>
        <div id="correlationPlot" class="plot"></div>
      </div>
    </div>
  </section>

  <script>
    const galaxyCountInput = document.getElementById('galaxyCount');
    const velocityDispersionInput = document.getElementById('velocityDispersion');
    const updateBtn = document.getElementById('updateBtn');
    const fetchGalaxiesBtn = document.getElementById('fetchGalaxiesBtn');
    const statusMessage = document.getElementById('statusMessage');

    let galaxiesData = null;  
    let firstFetch = true;

    async function fetchGalaxies(count) {
      const res = await fetch(`/api/galaxies?count=${count}`);
      const data = await res.json();
      return data;
    }

    function plotGalaxies(galaxies) {
      const trace = {
        x: galaxies.map(g => g.x),
        y: galaxies.map(g => g.y),
        z: galaxies.map(g => g.z_cart),
        mode: 'markers',
        type: 'scatter3d',
        marker: {
          size: 3,
          color: galaxies.map(g => g.z),
          colorscale: 'Viridis',
          colorbar: { title: 'Redshift (z)' },
          opacity: 0.8
        },
        text: galaxies.map(g => `RA: ${g.ra.toFixed(2)}°, Dec: ${g.dec.toFixed(2)}°, z: ${g.z.toFixed(3)}`),
        hoverinfo: 'text'
      };

      const layout = {
        margin: { l:0, r:0, b:0, t:0 },
        scene: {
          xaxis: { title: 'X (Mpc)' },
          yaxis: { title: 'Y (Mpc)' },
          zaxis: { title: 'Z (Mpc)' }
        }
      };

      Plotly.newPlot('galaxyPlot', [trace], layout, {responsive: true});
    }

    function plotCorrelation(data) {
      const traceReal = {
        x: data.r,
        y: data.xi_real,
        mode: 'lines+markers',
        name: 'Real Space',
        line: { color: 'blue' }
      };

      const traceRSD = {
        x: data.r,
        y: data.xi_rsd,
        mode: 'lines+markers',
        name: 'Redshift Space',
        line: { color: 'red', dash: 'dash' }
      };

      const layout = {
        xaxis: { title: 'Separation r (Mpc)' },
        yaxis: { title: 'Correlation function ξ(r)' },
        legend: { x: 0, y: 1 },
        margin: { t: 30 }
      };

      Plotly.newPlot('correlationPlot', [traceReal, traceRSD], layout, {responsive: true});
    }
    async function fetchGalaxiesAndUpdate() {
      let count, velocityDispersion;

      updateBtn.disabled = true;
      updateBtn.textContent = "Calculating Correlation...";

      if (firstFetch) {
        count = parseInt(galaxyCountInput.defaultValue);
        velocityDispersion = parseFloat(velocityDispersionInput.defaultValue);

        galaxyCountInput.value = count;
        velocityDispersionInput.value = velocityDispersion;

        firstFetch = false;
      } else {
        count = parseInt(galaxyCountInput.value);
        velocityDispersion = parseFloat(velocityDispersionInput.value);
      }

      try {
        galaxiesData = await fetchGalaxies(count);
        plotGalaxies(galaxiesData);

        const res = await fetch('/api/correlation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            velocity_dispersion: velocityDispersion,
            galaxies: galaxiesData
          })
        });

        if (!res.ok) {
          alert("Error fetching correlation data");
          return;
        }

        const correlationData = await res.json();
        plotCorrelation(correlationData);

      } catch (error) {
        alert("Error: " + error.message);
      } finally {
        updateBtn.disabled = false;
        updateBtn.textContent = "Recalculate Correlation";
      }
    }

    async function recalcCorrelationWithCurrentGalaxies() {
      if (!galaxiesData) {
        alert("Please fetch galaxies first.");
        return;
      }

      const velocityDispersion = parseFloat(velocityDispersionInput.value);

      statusMessage.style.display = 'block';
      updateBtn.disabled = true;
      updateBtn.textContent = "Calculations in progress...";

      try {
        const res = await fetch('/api/correlation', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            velocity_dispersion: velocityDispersion,
            galaxies: galaxiesData
          })
        });

        if (!res.ok) {
          alert("Error fetching correlation data");
          return;
        }

        const data = await res.json();

        galaxiesData = galaxiesData.map((g, i) => ({
          ...g,
          x: data.x_rsd[i],
          y: data.y_rsd[i],
          z_cart: data.z_rsd[i]
        }));

        plotGalaxies(galaxiesData);
        plotCorrelation(data);

      } catch (err) {
        alert("Error: " + err.message);
      } finally {
        statusMessage.style.display = 'none';
        updateBtn.disabled = false;
        updateBtn.textContent = "Recalculate Correlation";
      }
    }

    updateBtn.addEventListener('click', recalcCorrelationWithCurrentGalaxies);
    fetchGalaxiesBtn.addEventListener('click', fetchGalaxiesAndUpdate);
  </script>

</body>
</html>